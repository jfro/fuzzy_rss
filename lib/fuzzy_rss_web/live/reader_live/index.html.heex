<div class="flex h-screen bg-base-100">
  <!-- Sidebar -->
  <.live_component module={FuzzyRssWeb.ReaderLive.Sidebar} id="sidebar" {assigns} />

  <%= if @page_mode == :reader do %>
    <!-- Entry List -->
    <div class="flex-1 flex flex-col bg-base-100 min-w-0">
      <div class="flex flex-col bg-base-200 border-b border-base-300 px-4 py-3 gap-3">
        <div class="flex items-center min-w-0">
          <h2 class="text-xl font-bold flex items-center gap-2 min-w-0">
            <%= if @selected_feed do %>
              <% feed =
                Enum.find(@feeds, &(&1.id == @selected_feed)) ||
                  %{title: "Feed", favicon_url: nil} %>
              <%= if feed.favicon_url do %>
                <img src={feed.favicon_url} class="size-5 rounded-sm shrink-0" />
              <% end %>
              <span class="truncate">{feed.title}</span>
            <% else %>
              <%= if @selected_folder do %>
                <span class="truncate">
                  {(Enum.find(@folders, &(&1.id == @selected_folder)) || %{name: "Folder"}).name}
                </span>
              <% else %>
                {if @filter == :starred, do: "â­ Starred", else: "ğŸ“° All Entries"}
              <% end %>
            <% end %>
          </h2>
        </div>
        <div class="flex items-center gap-2">
          <%= if @selected_feed || @selected_folder do %>
            <button
              phx-click="toggle_feed_filter"
              class="btn btn-sm btn-ghost bg-base-300/50 hover:bg-base-300 gap-2"
              title="Toggle between unread and all articles"
            >
              {if @filter == :unread, do: "ğŸ“– Unread", else: "ğŸ“‹ All"}
            </button>
          <% end %>
          <button phx-click="mark_all_read" class="btn btn-sm btn-ghost gap-2">
            <.icon name="hero-check" class="h-4 w-4" /> Mark All Read
          </button>
        </div>
      </div>

      <div class="overflow-y-auto overflow-x-hidden flex-1 min-w-0">
        <%= if Enum.empty?(@entries) do %>
          <div class="flex items-center justify-center h-full">
            <div class="text-center">
              <p class="text-base-content/60 text-lg">No entries to display</p>
              <p class="text-base-content/40 text-sm mt-2">Add some feeds to get started!</p>
            </div>
          </div>
        <% else %>
          <%= for entry <- @entries do %>
            <% read = is_read?(entry) %>
            <div
              phx-click="select_entry"
              phx-value-entry_id={entry.id}
              class={"card card-compact bg-base-100 hover:bg-base-200 cursor-pointer transition-colors border-b border-base-300 rounded-none #{if @selected_entry && @selected_entry.id == entry.id, do: "bg-primary/20"} #{if read, do: "opacity-60"}"}
            >
              <div class="card-body overflow-hidden">
                <h3 class={"card-title text-base break-words #{if read, do: "font-normal text-base-content/70", else: "font-semibold"}"}>
                  {entry.title}
                </h3>
                <div class="flex gap-2 items-center text-xs text-base-content/60 flex-wrap">
                  <span class="badge badge-ghost badge-sm gap-1 max-w-[150px] sm:max-w-[200px]">
                    <%= if entry.feed.favicon_url do %>
                      <img src={entry.feed.favicon_url} class="size-3 rounded-sm shrink-0" />
                    <% end %>
                    <span class="truncate">{entry.feed.title}</span>
                  </span>
                  <span>Â·</span>
                  <span>{Calendar.strftime(entry.published_at, "%b %d, %Y")}</span>
                </div>
                <%= if entry.summary do %>
                  <p class={"text-sm line-clamp-2 break-words #{if read, do: "text-base-content/50", else: "text-base-content/80"}"}>
                    {raw(sanitize_summary(entry.summary))}
                  </p>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
    
<!-- Entry Detail -->
    <%= if @selected_entry do %>
      <.live_component
        module={FuzzyRssWeb.ReaderLive.EntryDetail}
        id="entry_detail"
        selected_entry={@selected_entry}
      />
    <% end %>
  <% else %>
    <!-- Management Content Area -->
    <div class="flex-1 overflow-y-auto bg-base-100">
      <%= case @live_action do %>
        <% :feeds -> %>
          <.live_component
            module={FuzzyRssWeb.ReaderLive.FeedManagement}
            id="feed_management"
            {assigns}
          />
        <% :feeds_new -> %>
          <.live_component
            module={FuzzyRssWeb.ReaderLive.FeedForm}
            id="feed_form"
            {assigns}
          />
        <% :feeds_discover -> %>
          <.live_component
            module={FuzzyRssWeb.ReaderLive.FeedDiscover}
            id="feed_discover"
            {assigns}
          />
        <% :folders -> %>
          <.live_component
            module={FuzzyRssWeb.ReaderLive.FolderManagement}
            id="folder_management"
            {assigns}
          />
        <% :settings -> %>
          <.live_component
            module={FuzzyRssWeb.ReaderLive.SettingsMenu}
            id="settings_menu"
            {assigns}
          />
        <% :settings_import_export -> %>
          <.live_component
            module={FuzzyRssWeb.ReaderLive.ImportExport}
            id="import_export"
            current_user={@current_user}
            opml_file_upload={@uploads.opml_file}
            starred_file_upload={@uploads.starred_file}
          />
        <% :account_settings -> %>
          <.live_component
            module={FuzzyRssWeb.ReaderLive.AccountSettings}
            id="account_settings"
            current_user={@current_user}
          />
      <% end %>
    </div>
  <% end %>
</div>
